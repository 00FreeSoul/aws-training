{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Infrastructure for AWS workshop demo application",

  "Parameters": {
    "KeyName": {
      "Description": "Name of an existing EC2 key pair to enable SSH access to the instance",
      "ConstraintDescription": "can contain only ASCII characters.",
      "Type": "String",
      "MinLength": "1", "MaxLength": "255", "AllowedPattern": "[\\x20-\\x7E]*"
    }
  },

  "Mappings": {
    "RegionMap": {
      "eu-west-1": {"AMI": "ami-f0b11187"},
      "eu-central-1": {"AMI": "ami-b83c0aa5"}
    }
  },

  "Resources": {
    "WebFront": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "KeyName": {"Ref": "KeyName"},
        "InstanceType": "t2.micro",
        "BlockDeviceMappings": [ {"DeviceName": "/dev/sda1", "Ebs": {"VolumeType": "gp2", "DeleteOnTermination": "true", "VolumeSize": "8"}} ],
        "SecurityGroups": [{"Ref": "SecGroupWebFront"}],
        "ImageId": {"Fn::FindInMap": [ "RegionMap", {"Ref": "AWS::Region"}, "AMI" ]},
        "Tags": [{"Key": "Name", "Value": {"Fn::Join": [ "-", [ { "Ref": "AWS::StackName" }, "WebFront" ] ]} }, {"Key": "DeploymentRole", "Value": "WebFront" }]
      }
    },
    "SecGroupWebFront": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Public access to Web server HTTP and SSH",
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "CidrIp": "0.0.0.0/0"},
          {"IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": "0.0.0.0/0"}
        ]
      }
    },
    "Worker": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "KeyName": {"Ref": "KeyName"},
        "InstanceType": "t2.micro",
        "BlockDeviceMappings": [ {"DeviceName": "/dev/sda1", "Ebs": {"VolumeType": "gp2", "DeleteOnTermination": "true", "VolumeSize": "8"}} ],
        "SecurityGroups": [{"Ref": "SecGroupWorker"}],
        "ImageId": {"Fn::FindInMap": [ "RegionMap", {"Ref": "AWS::Region"}, "AMI" ]},
        "Tags": [{"Key": "Name", "Value": {"Fn::Join": [ "-", [ { "Ref": "AWS::StackName" }, "Worker" ] ]} }, {"Key": "DeploymentRole", "Value": "Worker" }]
      }
    },
    "SecGroupWorker": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Public access to Web server HTTP and SSH",
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "CidrIp": "0.0.0.0/0"},
          {"IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": "0.0.0.0/0"}
        ]
      }
    }

  },

  "Outputs": {
    "InstanceIdWebFront": {
      "Description": "InstanceId of the newly created EC2 instance",
      "Value": {"Ref": "WebFront"}
    },
    "PublicDNSWebFront": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {"Fn::GetAtt": ["WebFront", "PublicDnsName"]}
    },
    "InstanceIdWorker": {
      "Description": "InstanceId of the newly created EC2 instance",
      "Value": {"Ref": "Worker"}
    },
    "PublicDNSWorker": {
      "Description": "Public DNSName of the newly created EC2 instance",
      "Value": {"Fn::GetAtt": ["Worker", "PublicDnsName"]}
    }
  }
}
